
#!/bin/bash
clear
sleep 3

rm -f ~/x

echo "Installing Termux-am..."
pkg install termux-am -y &>/dev/null
yes | pkg install wget
clear

termux-setup-storage & sleep 4 &>/dev/null

while true; do
    if [ -d ~/storage/shared ]; then
        break
    else
        echo "Storage permission denied"
    fi
    sleep 3
done

echo "Installing Termux packages..."
apt-get clean
apt-get update >/dev/null 2>&1
apt-get -y --with-new-pkgs -o Dpkg::Options::="--force-confdef" upgrade >/dev/null 2>&1

pkg install x11-repo -y &>/dev/null
pkg install pulseaudio -y &>/dev/null
pkg install xwayland -y &>/dev/null
pkg install wget -y &>/dev/null
pkg install tsu -y &>/dev/null
pkg install root-repo -y &>/dev/null
pkg install patchelf -y &>/dev/null
pkg install p7zip -y &>/dev/null
pkg install xorg-xrandr -y &>/dev/null
pkg install ncurses-utils -y &>/dev/null
pkg install hashdeep -y &>/dev/null
pkg install termux-x11-nightly -y &>/dev/null

if [ -e $PREFIX/glibc ]; then
    echo -n "Removing previous glibc. Continue? (Y/n) "
    read i
    if [ "$i" = "Y" ] || [ "$i" = "y" ]; then
        rm -rf $PREFIX/glibc
    else
        echo "Aborted"
        exit 1
    fi
fi

echo "Installing Mobox-remake..."

function wget-git-q {
    wget -q --retry-connrefused --tries=0 --header "PRIVATE-TOKEN: $PRIVATE_TOKEN" \
    "https://gitlab.com/api/v4/projects/$PROJECT_ID/repository/files/$1/raw?ref=main" -O $2
    return $?
}

mkdir -p $PREFIX/glibc/opt/package-manager/installed

echo "PRIVATE_TOKEN=glpat-nybXy782yrn2GFJQrwU8iW86MQp1Oml2NnI3Cw.01.1216l75cr PROJECT_ID=76144938" > $PREFIX/glibc/opt/package-manager/token
. $PREFIX/glibc/opt/package-manager/token

if ! wget-git-q "package-manager" "$PREFIX/glibc/opt/package-manager/package-manager"; then
    echo "Download failed"
    exit 1
fi

. $PREFIX/glibc/opt/package-manager/package-manager
sync-all
sync-package wine-9.3-vanilla-wow64

if [ -f "$PREFIX/glibc/opt/scripts/mobox-remake" ]; then
    ln -sf "$PREFIX/glibc/opt/scripts/mobox-remake" "$PREFIX/bin/mobox-remake"
    echo "To start - type 'mobox-remake'"
else
    echo "Error: mobox-remake not found in scripts folder"
fi
